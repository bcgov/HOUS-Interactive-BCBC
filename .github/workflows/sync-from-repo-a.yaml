name: sync-from-repo-a

on:
  workflow_run:
    workflows: ["generate-artifact"]
    types:
      - completed
    # branches: [main]

permissions:
  contents: write

jobs:
  sync:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout destination repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_B_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-files
          path: incoming

      - name: Replace replica files
        run: |
          # Ensure destination folders exist
          mkdir -p apps/web/public data/source

          # Sync BOTH graphic folders into apps/web/public/
          rsync -av --delete incoming/bc-graphic/ apps/web/public/bc-graphic/
          rsync -av --delete incoming/graphics/ apps/web/public/graphics/

          # Replace JSON schema files
          rsync -av incoming/bc-builing-code-schema.json data/source/
          rsync -av incoming/bcbc-2024.json data/source/

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add apps/web/public data/source

          # Only commit if something changed
          git diff --staged --quiet || git commit -m "chore: sync generated files from Repo A (run $GITHUB_RUN_ID)"

          git push
