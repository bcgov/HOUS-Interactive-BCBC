# BC Building Code Data Management Guide

Complete guide for managing BC Building Code source data and generated assets.

---

## Table of Contents

- [Overview](#overview)
- [Directory Structure](#directory-structure)
- [Source Data Location](#source-data-location)
- [Generated Assets Location](#generated-assets-location)
- [Data Flow](#data-flow)
- [File Size Considerations](#file-size-considerations)
- [Git Management](#git-management)
- [Build Pipeline](#build-pipeline)
- [Best Practices](#best-practices)

---

## Overview

The project uses a clear separation between **source data** (input) and **generated assets** (output):

- **Source Data:** Original BC Building Code JSON → `/data/source/`
- **Generated Assets:** Processed files for the web app → `/apps/web/public/data/`

---

## Directory Structure

```
bc-building-code/
│
├── data/                                    # Source data directory
│   ├── source/                             # ✅ PUT BC BUILDING CODE JSON HERE
│   │   ├── versions.json                  # Version configuration (NEW)
│   │   ├── bcbc-2024.json                 # Main source file (10-50 MB)
│   │   ├── bcbc-2027.json                 # Future version (when available)
│   │   └── README.md                       # Documentation
│   │
│   └── samples/                            # Sample/test data
│       ├── bcbc-sample.json               # Small sample for testing
│       └── README.md                       # Sample data docs
│
├── apps/web/public/data/                   # ❌ GENERATED - DON'T EDIT
│   ├── versions.json                      # Version index (generated)
│   ├── 2024/                              # Version-specific directory
│   │   ├── search/
│   │   │   ├── documents.json             # FlexSearch index
│   │   │   └── metadata.json              # Search metadata
│   │   ├── navigation-tree.json           # Navigation structure
│   │   ├── glossary-map.json              # Glossary definitions
│   │   ├── amendment-dates.json           # Available dates
│   │   ├── content-types.json             # Content type filters
│   │   ├── quick-access.json              # Homepage pins
│   │   └── content/                        # Content chunks
│   │       ├── nbc-diva/
│   │       │   ├── part-1/
│   │       │   │   ├── section-1.json
│   │       │   │   └── section-2.json
│   │       │   └── part-2/
│   │       └── nbc-divb/
│   └── 2027/                              # Future version (when available)
│       └── ... (same structure as 2024)
│
├── packages/
│   ├── bcbc-parser/                       # Reads from /data/source/
│   ├── search-indexer/                    # Processes parsed data
│   └── content-chunker/                   # Outputs to /apps/web/public/data/
│
└── scripts/
    └── generate-assets.ts                 # Orchestrates the pipeline
```

---

## Source Data Location

### Primary Location: `/data/source/`

**This is where you place BC Building Code JSON files and version configuration.**

### Version Configuration: `/data/source/versions.json`

**NEW:** Version metadata file that defines all available BC Building Code versions.

**Structure:**
```json
{
  "versions": [
    {
      "id": "2024",
      "year": 2024,
      "title": "BC Building Code 2024",
      "sourceFile": "bcbc-2024.json",
      "isDefault": true,
      "publishedDate": "2024-01-01",
      "status": "current"
    },
    {
      "id": "2027",
      "year": 2027,
      "title": "BC Building Code 2027",
      "sourceFile": "bcbc-2027.json",
      "isDefault": false,
      "publishedDate": "2027-01-01",
      "status": "draft"
    }
  ]
}
```

### Why This Location?

✅ **Separation of Concerns:** Source data separate from application code  
✅ **Clear Purpose:** `/data/source/` clearly indicates input data  
✅ **Build Pipeline:** Easy for build scripts to locate  
✅ **Version Control:** Easy to track changes to source data  
✅ **Multi-Version Support:** Single configuration for all versions  
✅ **Not Served:** Won't be served to clients (too large)  
✅ **Monorepo Friendly:** Accessible to all packages  

### File Naming Convention

```
data/source/
├── versions.json               # Version configuration (required)
├── bcbc-2024.json              # BC Building Code 2024
├── bcbc-2027.json              # BC Building Code 2027 (future)
└── README.md                   # Documentation
```

---

## Generated Assets Location

### Output Location: `/apps/web/public/data/`

**This directory contains files generated by the build pipeline.**

### Multi-Version Structure

**NEW:** Assets are now organized by version in separate directories.

```
apps/web/public/data/
├── versions.json                          # Version index (lists all versions)
├── 2024/                                  # BC Building Code 2024
│   ├── search/
│   │   ├── documents.json                 # FlexSearch index
│   │   └── metadata.json                  # Search metadata
│   ├── navigation-tree.json               # Navigation structure
│   ├── glossary-map.json                  # Glossary definitions
│   ├── amendment-dates.json               # Available dates
│   ├── content-types.json                 # Content type filters
│   ├── quick-access.json                  # Homepage pins
│   └── content/                            # Content chunks
│       └── [division]/[part]/[section].json
└── 2027/                                  # BC Building Code 2027 (future)
    └── ... (same structure as 2024)
```

### What Gets Generated?

**Per Version:**
1. **`search/documents.json`** - FlexSearch index for client-side search
2. **`search/metadata.json`** - Search metadata and configuration
3. **`navigation-tree.json`** - Hierarchical navigation structure
4. **`glossary-map.json`** - Term → Definition mappings
5. **`amendment-dates.json`** - Available effective dates
6. **`content-types.json`** - Content type filter options
7. **`quick-access.json`** - Homepage quick access pins
8. **`content/[division]/[part]/[section].json`** - Content chunks

**Global:**
1. **`versions.json`** - Index of all available versions with metadata

### Why This Location?

✅ **Public Directory:** Next.js serves files from `public/`  
✅ **Static Assets:** Can be fetched by the client  
✅ **Version Isolation:** Each version has its own directory  
✅ **Optimized:** Chunked for lazy loading  
✅ **Cacheable:** Can be cached by CDN  
✅ **Gitignored:** Not committed to version control  

### Important Notes

❌ **DON'T** manually edit files in `/apps/web/public/data/`  
❌ **DON'T** commit generated assets to Git  
✅ **DO** regenerate assets when source data changes  
✅ **DO** include in deployment builds  
✅ **DO** add new versions by updating `versions.json` and running build  

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                         BUILD TIME                               │
└─────────────────────────────────────────────────────────────────┘

1. Version Configuration
   /data/source/versions.json
   │
   ▼
2. For Each Version:
   /data/source/bcbc-{year}.json (10-50 MB)
   │
   ▼
3. Parse & Validate
   @bc-building-code/bcbc-parser
   │
   ├─▶ 4a. Generate Search Index
   │   @bc-building-code/search-indexer
   │   │
   │   ▼
   │   /apps/web/public/data/{version}/search/documents.json
   │   /apps/web/public/data/{version}/search/metadata.json
   │
   ├─▶ 4b. Extract Metadata
   │   @bc-building-code/content-chunker
   │   │
   │   ├─▶ /apps/web/public/data/{version}/navigation-tree.json
   │   ├─▶ /apps/web/public/data/{version}/glossary-map.json
   │   ├─▶ /apps/web/public/data/{version}/amendment-dates.json
   │   ├─▶ /apps/web/public/data/{version}/content-types.json
   │   └─▶ /apps/web/public/data/{version}/quick-access.json
   │
   └─▶ 4c. Chunk Content
       @bc-building-code/content-chunker
       │
       ▼
       /apps/web/public/data/{version}/content/[division]/[part]/[section].json

5. Generate Version Index
   │
   ▼
   /apps/web/public/data/versions.json

┌─────────────────────────────────────────────────────────────────┐
│                         RUNTIME                                  │
└─────────────────────────────────────────────────────────────────┘

6. Client Loads App
   │
   ├─▶ Load versions.json (on init)
   ├─▶ Select version (from URL, localStorage, or default)
   │
   ├─▶ Load version-specific data:
   │   ├─▶ Load search index (on init or lazy)
   │   ├─▶ Load navigation-tree.json (on init)
   │   ├─▶ Load glossary-map.json (on init)
   │   ├─▶ Load amendment-dates.json (on init)
   │   ├─▶ Load content-types.json (on init)
   │   └─▶ Load quick-access.json (on init)
   │
   └─▶ User Navigates
       │
       └─▶ Lazy load content chunks (on demand)
           /apps/web/public/data/{version}/content/[path].json

7. User Switches Version
   │
   ├─▶ Update URL with version parameter
   ├─▶ Clear cached data for old version
   ├─▶ Load data for new version (steps 6)
   └─▶ Re-render UI with new version data
```

---

## File Size Considerations

### Source File (`bcbc-2024.json`)

**Expected Size:** 10-50 MB (2000+ pages of content)

**Recommendations:**

| File Size | Recommendation |
|-----------|----------------|
| < 50 MB | ✅ Commit directly to Git |
| 50-100 MB | ⚠️ Consider Git LFS |
| > 100 MB | ✅ Use Git LFS |

### Generated Assets

**Total Size:** 15-70 MB (chunked)

**Breakdown:**
- `search-index.json`: 5-15 MB
- `navigation-tree.json`: 100-500 KB
- `glossary-map.json`: 50-200 KB
- `amendment-dates.json`: 1-5 KB
- `content/` chunks: 10-50 MB total (50-200 KB per chunk)

**Optimization:**
- Content is chunked by section (50-200 KB each)
- Lazy loaded on demand
- Cacheable by browser/CDN
- Gzip compression reduces size by ~70%

---

## Git Management

### What to Commit

✅ **DO commit:**
- `/data/source/bcbc-2024.json` (source data)
- `/data/samples/*.json` (sample data)
- `/data/source/README.md` (documentation)

❌ **DON'T commit:**
- `/apps/web/public/data/*` (generated assets)
- `/apps/web/.next/` (Next.js build)
- `/apps/web/out/` (static export)

### .gitignore Configuration

Already configured in `.gitignore`:

```gitignore
# Generated assets (output from build pipeline)
apps/web/public/data/

# Source data (optional - uncomment if file is too large)
# data/source/bcbc-*.json

# Keep sample data in Git
!data/samples/*.json
```

### Using Git LFS (for large files)

If `bcbc-2024.json` is > 100 MB:

```bash
# 1. Install Git LFS
git lfs install

# 2. Track large JSON files
git lfs track "data/source/*.json"

# 3. Commit .gitattributes
git add .gitattributes
git commit -m "Configure Git LFS for BC Building Code data"

# 4. Add the large file
git add data/source/bcbc-2024.json
git commit -m "Add BC Building Code 2024 source data"
```

### Verify Git LFS

```bash
# Check if file is tracked by LFS
git lfs ls-files

# Should show:
# data/source/bcbc-2024.json
```

---

## Build Pipeline

### Generate Assets Command

```bash
# Generate all static assets for all versions
npx pnpm generate-assets
```

### What Happens?

1. **Load Configuration:** Reads `/data/source/versions.json`
2. **For Each Version:**
   - **Parse:** Reads `/data/source/bcbc-{year}.json`
   - **Validate:** Checks JSON structure and schema
   - **Index:** Generates FlexSearch index
   - **Extract:** Creates navigation tree, glossary, dates, content types
   - **Chunk:** Splits content into optimized chunks
   - **Output:** Writes to `/apps/web/public/data/{versionId}/`
3. **Generate Index:** Creates unified `/apps/web/public/data/versions.json`

### When to Run?

Run `generate-assets` when:
- ✅ Source data changes
- ✅ First time setup
- ✅ Before deployment
- ✅ After pulling new source data
- ✅ When testing build pipeline
- ✅ **When adding a new version**

### Build Pipeline Script

Located at: `scripts/generate-assets.ts`

```typescript
// Orchestrates the entire multi-version pipeline
import { parseAndValidate } from '@bc-building-code/bcbc-parser';
import { generateIndex } from '@bc-building-code/search-indexer';
import { chunkContent, extractMetadata } from '@bc-building-code/content-chunker';

async function generateAssets() {
  // 1. Load version configuration
  const versionsConfig = await loadVersionsConfig('data/source/versions.json');
  
  // 2. For each version
  for (const version of versionsConfig.versions) {
    console.log(`Processing version ${version.id}...`);
    
    // 3. Parse source data
    const bcbcData = await parseAndValidate(`data/source/${version.sourceFile}`);
    
    // 4. Generate search index
    await generateIndex(bcbcData, `apps/web/public/data/${version.id}/search/`);
    
    // 5. Extract metadata
    await extractMetadata(bcbcData, `apps/web/public/data/${version.id}/`);
    
    // 6. Chunk content
    await chunkContent(bcbcData, `apps/web/public/data/${version.id}/content/`);
  }
  
  // 7. Generate versions index
  await generateVersionsIndex(versionsConfig, 'apps/web/public/data/versions.json');
}
```

---

## Metadata File Schemas

This section documents the structure of all generated metadata files in `/apps/web/public/data/{version}/`.

### 1. amendment-dates.json

**Purpose:** Available effective dates for filtering content by amendment dates

**Location:** `/apps/web/public/data/{version}/amendment-dates.json`

**Schema:**
```json
{
  "version": "2020",                    // Source version identifier
  "generatedAt": "2026-02-04T01:43:12.273Z",  // ISO timestamp of generation
  "dates": [
    {
      "effectiveDate": "2025-06-16",    // ISO date string (YYYY-MM-DD)
      "displayDate": "June 15, 2025",   // Human-readable date for display
      "count": 44,                       // Number of provisions affected
      "type": "amendment" | "original"   // Type of change
    }
  ]
}
```

**Field Descriptions:**
- `effectiveDate`: ISO 8601 date string used for filtering and sorting
- `displayDate`: Human-readable date string for UI display
- `count`: Number of articles, sections, or provisions affected by this date
- `type`: 
  - `"amendment"`: Changes made after original publication
  - `"original"`: Original provisions from initial publication

**Notes:**
- Dates are sorted in descending order (most recent first)
- The first date in the array is considered the "latest" date
- The amendment date store transforms this format to its internal format during loading
- Typical file size: 1-5 KB

**Runtime Transformation:**
The amendment date store (`apps/web/stores/amendment-date-store.ts`) transforms this JSON format to:
```typescript
interface AmendmentDate {
  date: string;           // From effectiveDate
  label: string;          // From displayDate
  description: string;    // Generated: "{count} {type === 'original' ? 'original provisions' : 'amendments'}"
  isLatest: boolean;      // true for first date in array
}
```

### 2. navigation-tree.json

**Purpose:** Hierarchical structure of the BC Building Code for navigation

**Location:** `/apps/web/public/data/{version}/navigation-tree.json`

**Schema:**
```json
{
  "version": "2020",
  "generatedAt": "2026-02-04T01:43:13.066Z",
  "divisions": [
    {
      "id": "nbc.divA",
      "type": "division",
      "number": "A",
      "title": "Compliance, Objectives and Functional Statements",
      "level": 0,
      "hasRevisions": false,
      "children": [
        {
          "id": "nbc.divA.part1",
          "type": "part",
          "number": 1,
          "title": "Compliance",
          "level": 1,
          "hasRevisions": false,
          "children": [ /* sections */ ]
        }
      ]
    }
  ]
}
```

**Field Descriptions:**
- `id`: Unique identifier for the node (e.g., "nbc.divA.part1.sect1")
- `type`: Node type ("division", "part", "section", "subsection", "article")
- `number`: Section number (string for divisions, number for others)
- `title`: Display title
- `level`: Depth in hierarchy (0 = division, 1 = part, etc.)
- `hasRevisions`: Whether this node or its children have amendments
- `children`: Array of child nodes (recursive structure)

**Notes:**
- Typical file size: 100-500 KB
- Used by NavigationTree component for sidebar
- Supports expand/collapse functionality
- Enables breadcrumb generation

### 3. glossary-map.json

**Purpose:** Term definitions for inline glossary tooltips

**Location:** `/apps/web/public/data/{version}/glossary-map.json`

**Schema:**
```json
{
  "version": "2020",
  "generatedAt": "2026-02-04T01:43:13.066Z",
  "terms": {
    "building": {
      "term": "building",
      "definition": "Any structure used or intended for supporting or sheltering any use or occupancy.",
      "relatedTerms": ["structure", "occupancy"]
    }
  }
}
```

**Notes:**
- Typical file size: 50-200 KB
- Used for inline term highlighting and tooltips
- Case-insensitive term matching

### 4. content-types.json

**Purpose:** Available content types for search filtering

**Location:** `/apps/web/public/data/{version}/content-types.json`

**Schema:**
```json
{
  "version": "2020",
  "generatedAt": "2026-02-04T01:43:13.066Z",
  "types": [
    {
      "id": "article",
      "label": "Articles",
      "count": 1234
    },
    {
      "id": "table",
      "label": "Tables",
      "count": 89
    }
  ]
}
```

**Notes:**
- Typical file size: 1-2 KB
- Used for content type filter dropdown

### 5. quick-access.json

**Purpose:** Pinned items for homepage quick access

**Location:** `/apps/web/public/data/{version}/quick-access.json`

**Schema:**
```json
{
  "version": "2020",
  "generatedAt": "2026-02-04T01:43:13.066Z",
  "pins": [
    {
      "id": "nbc.divB.part3",
      "title": "Fire Protection, Occupant Safety and Accessibility",
      "path": "/code/division-b/part-3",
      "type": "part"
    }
  ]
}
```

**Notes:**
- Typical file size: 1-3 KB
- Used for homepage quick access cards

### 6. search/documents.json

**Purpose:** FlexSearch index for client-side search

**Location:** `/apps/web/public/data/{version}/search/documents.json`

**Notes:**
- Typical file size: 5-15 MB
- Binary FlexSearch index format
- Loaded by search client on initialization
- Enables instant client-side search

### 7. search/metadata.json

**Purpose:** Search configuration and metadata

**Location:** `/apps/web/public/data/{version}/search/metadata.json`

**Schema:**
```json
{
  "version": "2020",
  "generatedAt": "2026-02-04T01:43:13.066Z",
  "documentCount": 5432,
  "indexSize": 12345678,
  "config": {
    "tokenize": "forward",
    "resolution": 9
  }
}
```

**Notes:**
- Typical file size: 1-2 KB
- Used for search statistics and configuration

---

## Best Practices

### 1. Source Data Management

✅ **DO:**
- Keep source data in `/data/source/`
- Document any changes to source data
- Use semantic versioning for data files
- Validate JSON before committing
- Use Git LFS for files > 100 MB

❌ **DON'T:**
- Edit generated assets manually
- Commit generated assets to Git
- Store source data in multiple locations
- Mix source and generated data

### 2. Development Workflow

```bash
# 1. Update source data
cp ~/Downloads/bcbc-2024.json data/source/

# 2. Validate the data
npx pnpm --filter @bc-building-code/bcbc-parser validate data/source/bcbc-2024.json

# 3. Generate assets
npx pnpm generate-assets

# 4. Test the application
npx pnpm dev

# 5. Commit source data (if changed)
git add data/source/bcbc-2024.json
git commit -m "Update BC Building Code to version 2024.1"
```

### 3. Testing with Sample Data

For faster development:

```bash
# Use sample data
cp data/samples/bcbc-sample.json data/source/bcbc-2024.json

# Generate assets (much faster)
npx pnpm generate-assets

# Develop with sample data
npx pnpm dev
```

### 4. CI/CD Pipeline

```yaml
# .github/workflows/build.yml
- name: Generate Assets
  run: |
    # Use sample data for CI
    cp data/samples/bcbc-sample.json data/source/bcbc-2024.json
    npx pnpm generate-assets
    
- name: Build Application
  run: npx pnpm build
```

### 5. Deployment

```bash
# Production deployment
# 1. Ensure source data is up to date
ls -lh data/source/bcbc-2024.json

# 2. Generate production assets
NODE_ENV=production npx pnpm generate-assets

# 3. Build application
npx pnpm build

# 4. Deploy (static files in apps/web/out/)
# Include apps/web/out/ in deployment
```

---

## Troubleshooting

### Issue: Source file not found

```bash
# Check if file exists
ls -lh data/source/bcbc-2024.json

# If missing, add it
cp ~/path/to/bcbc-2024.json data/source/
```

### Issue: Generated assets missing

```bash
# Regenerate assets
npx pnpm generate-assets

# Check output
ls -lh apps/web/public/data/
```

### Issue: File too large for Git

```bash
# Use Git LFS
git lfs track "data/source/*.json"
git add .gitattributes
git add data/source/bcbc-2024.json
```

### Issue: Build pipeline fails

```bash
# Validate source JSON
cat data/source/bcbc-2024.json | jq . > /dev/null

# Run with debug logging
DEBUG=* npx pnpm generate-assets
```

---

## Quick Reference

| Task | Command |
|------|---------|
| Add source data | `cp ~/bcbc-2024.json data/source/` |
| Validate data | `npx pnpm --filter @bc-building-code/bcbc-parser validate data/source/bcbc-2024.json` |
| Generate assets | `npx pnpm generate-assets` |
| Use sample data | `cp data/samples/bcbc-sample.json data/source/bcbc-2024.json` |
| Check file size | `ls -lh data/source/bcbc-2024.json` |
| Setup Git LFS | `git lfs track "data/source/*.json"` |
| Clean generated | `rm -rf apps/web/public/data/*` |

---

**Last Updated:** January 19, 2026  
**Version:** 1.0
