# BC Building Code Data Management Guide

Complete guide for managing BC Building Code source data and generated assets.

---

## Table of Contents

- [Overview](#overview)
- [Directory Structure](#directory-structure)
- [Source Data Location](#source-data-location)
- [Generated Assets Location](#generated-assets-location)
- [Data Flow](#data-flow)
- [File Size Considerations](#file-size-considerations)
- [Git Management](#git-management)
- [Build Pipeline](#build-pipeline)
- [Best Practices](#best-practices)

---

## Overview

The project uses a clear separation between **source data** (input) and **generated assets** (output):

- **Source Data:** Original BC Building Code JSON → `/data/source/`
- **Generated Assets:** Processed files for the web app → `/apps/web/public/data/`

---

## Directory Structure

```
bc-building-code/
│
├── data/                                    # Source data directory
│   ├── source/                             # ✅ PUT BC BUILDING CODE JSON HERE
│   │   ├── bcbc-2024.json                 # Main source file (10-50 MB)
│   │   ├── bcbc-2024-amendments.json      # Optional amendments
│   │   └── README.md                       # Documentation
│   │
│   └── samples/                            # Sample/test data
│       ├── bcbc-sample.json               # Small sample for testing
│       └── README.md                       # Sample data docs
│
├── apps/web/public/data/                   # ❌ GENERATED - DON'T EDIT
│   ├── search-index.json                  # FlexSearch index
│   ├── navigation-tree.json               # Navigation structure
│   ├── glossary-map.json                  # Glossary definitions
│   ├── amendment-dates.json               # Available dates
│   └── content/                            # Content chunks
│       ├── divA/
│       │   ├── part1/
│       │   │   ├── section1.json
│       │   │   └── section2.json
│       │   └── part2/
│       └── divB/
│
├── packages/
│   ├── bcbc-parser/                       # Reads from /data/source/
│   ├── search-indexer/                    # Processes parsed data
│   └── content-chunker/                   # Outputs to /apps/web/public/data/
│
└── scripts/
    └── generate-assets.ts                 # Orchestrates the pipeline
```

---

## Source Data Location

### Primary Location: `/data/source/bcbc-2024.json`

**This is where you place the BC Building Code JSON file.**

### Why This Location?

✅ **Separation of Concerns:** Source data separate from application code  
✅ **Clear Purpose:** `/data/source/` clearly indicates input data  
✅ **Build Pipeline:** Easy for build scripts to locate  
✅ **Version Control:** Easy to track changes to source data  
✅ **Not Served:** Won't be served to clients (too large)  
✅ **Monorepo Friendly:** Accessible to all packages  

### File Naming Convention

```
data/source/
├── bcbc-2024.json              # Main BC Building Code 2024
├── bcbc-2024-amendments.json   # Optional: Separate amendments
└── bcbc-2025.json              # Future: Next version
```

---

## Generated Assets Location

### Output Location: `/apps/web/public/data/`

**This directory contains files generated by the build pipeline.**

### What Gets Generated?

1. **`search-index.json`** - FlexSearch index for client-side search
2. **`navigation-tree.json`** - Hierarchical navigation structure
3. **`glossary-map.json`** - Term → Definition mappings
4. **`amendment-dates.json`** - Available effective dates
5. **`content/[division]/[part]/[section].json`** - Content chunks

### Why This Location?

✅ **Public Directory:** Next.js serves files from `public/`  
✅ **Static Assets:** Can be fetched by the client  
✅ **Optimized:** Chunked for lazy loading  
✅ **Cacheable:** Can be cached by CDN  
✅ **Gitignored:** Not committed to version control  

### Important Notes

❌ **DON'T** manually edit files in `/apps/web/public/data/`  
❌ **DON'T** commit generated assets to Git  
✅ **DO** regenerate assets when source data changes  
✅ **DO** include in deployment builds  

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                         BUILD TIME                               │
└─────────────────────────────────────────────────────────────────┘

1. Source Data
   /data/source/bcbc-2024.json (10-50 MB)
   │
   ▼
2. Parse & Validate
   @bc-building-code/bcbc-parser
   │
   ├─▶ 3a. Generate Search Index
   │   @bc-building-code/search-indexer
   │   │
   │   ▼
   │   /apps/web/public/data/search-index.json
   │
   ├─▶ 3b. Extract Metadata
   │   @bc-building-code/content-chunker
   │   │
   │   ├─▶ /apps/web/public/data/navigation-tree.json
   │   ├─▶ /apps/web/public/data/glossary-map.json
   │   └─▶ /apps/web/public/data/amendment-dates.json
   │
   └─▶ 3c. Chunk Content
       @bc-building-code/content-chunker
       │
       ▼
       /apps/web/public/data/content/[division]/[part]/[section].json

┌─────────────────────────────────────────────────────────────────┐
│                         RUNTIME                                  │
└─────────────────────────────────────────────────────────────────┘

4. Client Loads App
   │
   ├─▶ Load search-index.json (on init)
   ├─▶ Load navigation-tree.json (on init)
   ├─▶ Load glossary-map.json (on init)
   ├─▶ Load amendment-dates.json (on init)
   │
   └─▶ Lazy load content chunks (on navigation)
       /apps/web/public/data/content/divA/part1/section1.json
```

---

## File Size Considerations

### Source File (`bcbc-2024.json`)

**Expected Size:** 10-50 MB (2000+ pages of content)

**Recommendations:**

| File Size | Recommendation |
|-----------|----------------|
| < 50 MB | ✅ Commit directly to Git |
| 50-100 MB | ⚠️ Consider Git LFS |
| > 100 MB | ✅ Use Git LFS |

### Generated Assets

**Total Size:** 15-70 MB (chunked)

**Breakdown:**
- `search-index.json`: 5-15 MB
- `navigation-tree.json`: 100-500 KB
- `glossary-map.json`: 50-200 KB
- `amendment-dates.json`: 1-5 KB
- `content/` chunks: 10-50 MB total (50-200 KB per chunk)

**Optimization:**
- Content is chunked by section (50-200 KB each)
- Lazy loaded on demand
- Cacheable by browser/CDN
- Gzip compression reduces size by ~70%

---

## Git Management

### What to Commit

✅ **DO commit:**
- `/data/source/bcbc-2024.json` (source data)
- `/data/samples/*.json` (sample data)
- `/data/source/README.md` (documentation)

❌ **DON'T commit:**
- `/apps/web/public/data/*` (generated assets)
- `/apps/web/.next/` (Next.js build)
- `/apps/web/out/` (static export)

### .gitignore Configuration

Already configured in `.gitignore`:

```gitignore
# Generated assets (output from build pipeline)
apps/web/public/data/

# Source data (optional - uncomment if file is too large)
# data/source/bcbc-*.json

# Keep sample data in Git
!data/samples/*.json
```

### Using Git LFS (for large files)

If `bcbc-2024.json` is > 100 MB:

```bash
# 1. Install Git LFS
git lfs install

# 2. Track large JSON files
git lfs track "data/source/*.json"

# 3. Commit .gitattributes
git add .gitattributes
git commit -m "Configure Git LFS for BC Building Code data"

# 4. Add the large file
git add data/source/bcbc-2024.json
git commit -m "Add BC Building Code 2024 source data"
```

### Verify Git LFS

```bash
# Check if file is tracked by LFS
git lfs ls-files

# Should show:
# data/source/bcbc-2024.json
```

---

## Build Pipeline

### Generate Assets Command

```bash
# Generate all static assets from source data
npx pnpm generate-assets
```

### What Happens?

1. **Parse:** Reads `/data/source/bcbc-2024.json`
2. **Validate:** Checks JSON structure and schema
3. **Index:** Generates FlexSearch index
4. **Extract:** Creates navigation tree, glossary, dates
5. **Chunk:** Splits content into optimized chunks
6. **Output:** Writes to `/apps/web/public/data/`

### When to Run?

Run `generate-assets` when:
- ✅ Source data changes
- ✅ First time setup
- ✅ Before deployment
- ✅ After pulling new source data
- ✅ When testing build pipeline

### Build Pipeline Script

Located at: `scripts/generate-assets.ts`

```typescript
// Orchestrates the entire pipeline
import { parseAndValidate } from '@bc-building-code/bcbc-parser';
import { generateIndex } from '@bc-building-code/search-indexer';
import { chunkContent, extractMetadata } from '@bc-building-code/content-chunker';

async function generateAssets() {
  // 1. Parse source data
  const bcbcData = await parseAndValidate('data/source/bcbc-2024.json');
  
  // 2. Generate search index
  await generateIndex(bcbcData, 'apps/web/public/data/search-index.json');
  
  // 3. Extract metadata
  await extractMetadata(bcbcData, 'apps/web/public/data/');
  
  // 4. Chunk content
  await chunkContent(bcbcData, 'apps/web/public/data/content/');
}
```

---

## Best Practices

### 1. Source Data Management

✅ **DO:**
- Keep source data in `/data/source/`
- Document any changes to source data
- Use semantic versioning for data files
- Validate JSON before committing
- Use Git LFS for files > 100 MB

❌ **DON'T:**
- Edit generated assets manually
- Commit generated assets to Git
- Store source data in multiple locations
- Mix source and generated data

### 2. Development Workflow

```bash
# 1. Update source data
cp ~/Downloads/bcbc-2024.json data/source/

# 2. Validate the data
npx pnpm --filter @bc-building-code/bcbc-parser validate data/source/bcbc-2024.json

# 3. Generate assets
npx pnpm generate-assets

# 4. Test the application
npx pnpm dev

# 5. Commit source data (if changed)
git add data/source/bcbc-2024.json
git commit -m "Update BC Building Code to version 2024.1"
```

### 3. Testing with Sample Data

For faster development:

```bash
# Use sample data
cp data/samples/bcbc-sample.json data/source/bcbc-2024.json

# Generate assets (much faster)
npx pnpm generate-assets

# Develop with sample data
npx pnpm dev
```

### 4. CI/CD Pipeline

```yaml
# .github/workflows/build.yml
- name: Generate Assets
  run: |
    # Use sample data for CI
    cp data/samples/bcbc-sample.json data/source/bcbc-2024.json
    npx pnpm generate-assets
    
- name: Build Application
  run: npx pnpm build
```

### 5. Deployment

```bash
# Production deployment
# 1. Ensure source data is up to date
ls -lh data/source/bcbc-2024.json

# 2. Generate production assets
NODE_ENV=production npx pnpm generate-assets

# 3. Build application
npx pnpm build

# 4. Deploy (static files in apps/web/out/)
# Include apps/web/out/ in deployment
```

---

## Troubleshooting

### Issue: Source file not found

```bash
# Check if file exists
ls -lh data/source/bcbc-2024.json

# If missing, add it
cp ~/path/to/bcbc-2024.json data/source/
```

### Issue: Generated assets missing

```bash
# Regenerate assets
npx pnpm generate-assets

# Check output
ls -lh apps/web/public/data/
```

### Issue: File too large for Git

```bash
# Use Git LFS
git lfs track "data/source/*.json"
git add .gitattributes
git add data/source/bcbc-2024.json
```

### Issue: Build pipeline fails

```bash
# Validate source JSON
cat data/source/bcbc-2024.json | jq . > /dev/null

# Run with debug logging
DEBUG=* npx pnpm generate-assets
```

---

## Quick Reference

| Task | Command |
|------|---------|
| Add source data | `cp ~/bcbc-2024.json data/source/` |
| Validate data | `npx pnpm --filter @bc-building-code/bcbc-parser validate data/source/bcbc-2024.json` |
| Generate assets | `npx pnpm generate-assets` |
| Use sample data | `cp data/samples/bcbc-sample.json data/source/bcbc-2024.json` |
| Check file size | `ls -lh data/source/bcbc-2024.json` |
| Setup Git LFS | `git lfs track "data/source/*.json"` |
| Clean generated | `rm -rf apps/web/public/data/*` |

---

**Last Updated:** January 19, 2026  
**Version:** 1.0
